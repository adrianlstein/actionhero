<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Cluster | actionhero</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="../../assets/css/main.css">
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="../../assets/js/search.js" data-base="../..">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="../../index.html" class="title">actionhero</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
							<input type="checkbox" id="tsd-filter-externals" checked />
							<label class="tsd-widget" for="tsd-filter-externals">Externals</label>
							<input type="checkbox" id="tsd-filter-only-exported" />
							<label class="tsd-widget" for="tsd-filter-only-exported">Only exported</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<ul class="tsd-breadcrumb">
			</ul>
			<h1> Cluster</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<p><img src="cluster-ready.svg" alt=""></p>
				<a href="#overview" id="overview" style="color: inherit; text-decoration: none;">
					<h2>Overview</h2>
				</a>
				<p><strong><em>AKA: Running ActionHero in a Cluster</em></strong></p>
				<p>ActionHero can be run either as a solitary server or as part of a cluster. The goal of these cluster helpers is to allow you to create a group of servers which will share state and each be able to handle requests and run tasks. You can add or remove nodes from the cluster without fear of data loss or task duplication. You can also run many instances of ActionHero on the same server using node.js cluster methods (<code>actionhero start cluster</code>), which you <a href="tutorial-production-notes.html">can learn more about here</a>.</p>
				<p>Cluster instances are named sequentially, starting with <code>actionhero-worker-1</code>, and can be retrieved from &#39;api.id&#39;. Logs and PID&#39;s, as well as other instance-specific information follow this pattern as well.</p>
				<a href="#cache" id="cache" style="color: inherit; text-decoration: none;">
					<h2>Cache</h2>
				</a>
				<p>Using a <a href="http://redis.io">redis</a> backend, ActionHero nodes share memory objects (using the <code>api.cache methods</code>) and have a common queue for tasks. This means that all peers will have access to all data stored in the cache. The task system also becomes a common queue which all peers will work on draining. There should be no changes required to deploy your application in a cluster.</p>
				<p>Keep in mind that many clients/server can access a cached value simultaneously, so build your actions carefully not to have conflicting state. You can <a href="api.cache.html">learn more about the cache methods here</a>. You can also <a href="tutorial-production-notes.html">review recommendations about Production Redis configurations</a>.</p>
				<a href="#rpc" id="rpc" style="color: inherit; text-decoration: none;">
					<h2>RPC</h2>
				</a>
				<p>In version 9.0.0, ActionHero introduced Remote Procedure Calls, or RPC for short. You can call an RPC method to be executed on all nodes in your cluster or just a node which holds a specific connection. You can call RPC methods with the <code>api.redis.doCluster</code> method. If you provide the optional callback, you will get the first response back (or a timeout error). RPC calls are invoked with <code>api.redis.doCluster(method, args, connectionId, waitForResponse)</code>.</p>
				<p>For example, if you wanted all nodes to log a message, you would do: <code>api.redis.doCluster(&#39;api.log&#39;, [&quot;hello from &quot; + api.id])</code></p>
				<p>If you wanted the node which holds connection <code>abc123</code> to change their <code>authorized</code> status (perhaps because your room authentication relies on this), you would do:</p>
				<pre><code class="language-js"><span class="hljs-comment">// This will ask all nodes connected to the cluster if they have connection #\`abc123\`</span>
<span class="hljs-comment">//   and if they do, run \`connection.set('auth', true)\` on it</span>
<span class="hljs-keyword">await</span> api.connections.apply(<span class="hljs-string">'abc123'</span>, <span class="hljs-string">'set'</span>, [<span class="hljs-string">'auth'</span>, <span class="hljs-literal">true</span>]);</code></pre>
				<p>The RPC system is used heavily by Chat.</p>
				<p>Two options have been added to the <code>config/redis.js</code> config file to support this: <code>api.config.general.channel</code> ( Which channel to use on redis pub/sub for RPC communication ) and <code>api.config.general.rpcTimeout</code> ( How long to wait for an RPC call before considering it a failure )</p>
				<p><strong>WARNING</strong></p>
				<p>RPC calls are authenticated against <code>api.config.serverToken</code> and communication happens over redis pub/sub. BE CAREFUL, as you can call <em>any</em> method within the API namespace on an ActionHero server, including shutdown() and read <em>any</em> data on that node.</p>
				<a href="#connections" id="connections" style="color: inherit; text-decoration: none;">
					<h2>Connections</h2>
				</a>
				<p>Some special RPC tools have been added so that you can interact with connections across multiple nodes. Specifically the chat sub-system needs to be able to boot and move connections into rooms, regardless of which node they are connected to.</p>
				<p>ActionHero has exposed <code>api.connections.apply</code> which can be used to retrieve data about and modify a connection on any node.</p>
				<a href="#codeapiconnectionsapplyconnectionid-method-argscode" id="codeapiconnectionsapplyconnectionid-method-argscode" style="color: inherit; text-decoration: none;">
					<h3><code>api.connections.apply(connectionId, method, args)</code></h3>
				</a>
				<ul>
					<li><a href="api.connections.html">Learn More</a></li>
					<li>connectionId is required</li>
					<li>Both <code>method</code> and <code>args</code> can be ignored if you just want to retrieve information about a connection, IE: <code>const connectionDetails = await api.connections.apply(connectionId)</code></li>
				</ul>
				<a href="#pubsub" id="pubsub" style="color: inherit; text-decoration: none;">
					<h2>PubSub</h2>
				</a>
				<pre><code class="language-js"><span class="hljs-comment">// To subscribe to messages, add a callback for your \`messageType\`, IE:</span>
api.redis.subscriptionHandlers[<span class="hljs-string">'myMessageType'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>)</span>{
  <span class="hljs-comment">// do stuff</span>
}

<span class="hljs-comment">// send a message</span>
<span class="hljs-keyword">const</span> payload = {
  <span class="hljs-attr">messageType</span>: <span class="hljs-string">'myMessageType'</span>,
  <span class="hljs-attr">serverId</span>: api.id,
  <span class="hljs-attr">serverToken</span>: api.config.general.serverToken,
  <span class="hljs-attr">message</span>: <span class="hljs-string">'hello!'</span>,
}

<span class="hljs-keyword">await</span> api.redis.publish(payload)</code></pre>
				<p>ActionHero also uses redis to allow for pub/sub communication between nodes.</p>
				<p>You can broadcast and receive messages from other peers in the cluster:</p>
				<a href="#codeapiredispublishpayloadcode" id="codeapiredispublishpayloadcode" style="color: inherit; text-decoration: none;">
					<h3><code>api.redis.publish(payload)</code></h3>
				</a>
				<ul>
					<li><a href="api.redis.html">Learn More</a></li>
					<li>payload must contain:<ul>
							<li><code>messageType</code> : the name of your payload type,</li>
							<li><code>serverId</code> : <code>api.id</code>,</li>
							<li><code>serverToken</code> : <code>api.config.general.serverToken</code>,</li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class="globals  ">
						<a href="../../globals.html"><em>Globals</em></a>
					</li>
					<li class="current ">
						<a href="../index.html">Tutorial index</a>
						<ul>
							<li class=" ">
								<a href="../core/index.html">Actionhero <wbr>Core <wbr>Features</a>
							</li>
							<li class=" ">
								<a href="../config-and-dev/index.html">Configuration and <wbr>Development</a>
							</li>
							<li class="current ">
								<a href="index.html">Advanced <wbr>Actionhero <wbr>Topics</a>
								<ul>
									<li class=" ">
										<a href="plugins.html">Plugins</a>
									</li>
									<li class="current ">
										<a href="cluster.html">Cluster</a>
									</li>
									<li class=" ">
										<a href="production-notes.html">Production <wbr>Notes</a>
									</li>
									<li class=" ">
										<a href="upgrade-path.html">Upgrade <wbr>Path</a>
									</li>
								</ul>
							</li>
						</ul>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer class="with-border-bottom">
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-module"><span class="tsd-kind-icon">Module</span></li>
				<li class="tsd-kind-object-literal"><span class="tsd-kind-icon">Object literal</span></li>
				<li class="tsd-kind-variable"><span class="tsd-kind-icon">Variable</span></li>
				<li class="tsd-kind-function"><span class="tsd-kind-icon">Function</span></li>
				<li class="tsd-kind-function tsd-has-type-parameter"><span class="tsd-kind-icon">Function with type parameter</span></li>
				<li class="tsd-kind-index-signature"><span class="tsd-kind-icon">Index signature</span></li>
				<li class="tsd-kind-type-alias"><span class="tsd-kind-icon">Type alias</span></li>
				<li class="tsd-kind-type-alias tsd-has-type-parameter"><span class="tsd-kind-icon">Type alias with type parameter</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-enum"><span class="tsd-kind-icon">Enumeration</span></li>
				<li class="tsd-kind-enum-member"><span class="tsd-kind-icon">Enumeration member</span></li>
				<li class="tsd-kind-property tsd-parent-kind-enum"><span class="tsd-kind-icon">Property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-enum"><span class="tsd-kind-icon">Method</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-interface"><span class="tsd-kind-icon">Interface</span></li>
				<li class="tsd-kind-interface tsd-has-type-parameter"><span class="tsd-kind-icon">Interface with type parameter</span></li>
				<li class="tsd-kind-constructor tsd-parent-kind-interface"><span class="tsd-kind-icon">Constructor</span></li>
				<li class="tsd-kind-property tsd-parent-kind-interface"><span class="tsd-kind-icon">Property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-interface"><span class="tsd-kind-icon">Method</span></li>
				<li class="tsd-kind-index-signature tsd-parent-kind-interface"><span class="tsd-kind-icon">Index signature</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-class"><span class="tsd-kind-icon">Class</span></li>
				<li class="tsd-kind-class tsd-has-type-parameter"><span class="tsd-kind-icon">Class with type parameter</span></li>
				<li class="tsd-kind-constructor tsd-parent-kind-class"><span class="tsd-kind-icon">Constructor</span></li>
				<li class="tsd-kind-property tsd-parent-kind-class"><span class="tsd-kind-icon">Property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class"><span class="tsd-kind-icon">Method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class"><span class="tsd-kind-icon">Accessor</span></li>
				<li class="tsd-kind-index-signature tsd-parent-kind-class"><span class="tsd-kind-icon">Index signature</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-constructor tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited constructor</span></li>
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited accessor</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-protected"><span class="tsd-kind-icon">Protected property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class tsd-is-protected"><span class="tsd-kind-icon">Protected method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class tsd-is-protected"><span class="tsd-kind-icon">Protected accessor</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private accessor</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static property</span></li>
				<li class="tsd-kind-call-signature tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static method</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="container tsd-generator">
	<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p>
</div>
<div class="overlay"></div>
<script src="../../assets/js/main.js"></script>
<script>if (location.protocol == 'file:') document.write('<script src="../../assets/js/search.js"><' + '/script>');</script>
</body>
</html>